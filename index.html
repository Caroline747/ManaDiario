<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vers√≠culos Di√°rios ‚Äî Gerador</title>
  <link rel="stylesheet" href="style.css">

  <!-- PWA manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#D4A373">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

</head>
<body>
  <main class="app" id="app">

    <header>
      <h1>Vers√≠culos & Devocional</h1>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="darkToggle" class="btn ghost" title="Modo escuro">üåô</button>
        <button id="installBtn" class="btn ghost" style="display:none">Instalar</button>
      </div>
    </header>

    <!-- Home / Vers√≠culo do dia -->
    <section id="home" class="card verse-card">
      <div>
        <div class="verse-text" id="verseText">Carregando vers√≠culo...</div>
        <div class="verse-ref" id="verseRef"></div>
      </div>

      <div class="controls">
        <button id="generateBtn" class="btn">Gerar Novo</button>
        <button id="favBtn" class="btn ghost">‚ù§Ô∏è Favoritar</button>
        <button id="shareBtn" class="btn ghost">üîó Compartilhar</button>
      </div>

      <div class="devotional" id="devotional">‚Äî</div>

      <nav class="bottom">
        <div class="tab" id="openFav">Favoritos</div>
        <div class="tab" id="openHist">Hist√≥rico</div>
      </nav>
    </section>

    <!-- Favoritos -->
    <section id="favorites" class="card" style="display:none">
      <h2 style="margin-top:0">Favoritos</h2>
      <div class="list" id="favList"></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="backFromFav" class="btn ghost">Voltar</button>
        <button id="clearFav" class="btn ghost">Limpar favoritos</button>
      </div>
    </section>

    <!-- Hist√≥rico -->
    <section id="history" class="card" style="display:none">
      <h2 style="margin-top:0">Hist√≥rico</h2>
      <div class="list" id="histList"></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="backFromHist" class="btn ghost">Voltar</button>
        <button id="clearHist" class="btn ghost">Limpar hist√≥rico</button>
      </div>
    </section>

  </main>

  <script>
    /* ====== Dados e fallback ====== */
    const FALLBACK_VERSES = [
      {text:'Blessed are the peacemakers, for they will be called children of God.', ref:'Mateus 5:9', devotional:'A paz nasce quando escolhemos perdoar e estender compreens√£o.'},
      {text:'Be strong and courageous. Do not be afraid; do not be discouraged, for the Lord your God will be with you.', ref:'Josu√© 1:9', devotional:'For√ßa vem de confiar que n√£o estamos sozinhos.'},
      {text:'Do not be anxious about anything, but in every situation, by prayer and petition, with thanksgiving, present your requests to God.', ref:'Filipenses 4:6', devotional:'A ora√ß√£o transforma ansiedade em paz.'},
      {text:'Trust in the Lord with all your heart and lean not on your own understanding.', ref:'Prov√©rbios 3:5', devotional:'Confie, mesmo quando tudo parecer incerto.'}
    ];

    const apiBase = 'https://bible-api.com/'; // usado para buscas por refer√™ncia

    /* ====== App state ====== */
    const state = { current: null };

    /* ====== Elementos ====== */
    const verseText = document.getElementById('verseText');
    const verseRef = document.getElementById('verseRef');
    const devotionalEl = document.getElementById('devotional');
    const generateBtn = document.getElementById('generateBtn');
    const favBtn = document.getElementById('favBtn');
    const shareBtn = document.getElementById('shareBtn');

    const openFavBtn = document.getElementById('openFav');
    const openHistBtn = document.getElementById('openHist');

    const favoritesSection = document.getElementById('favorites');
    const homeSection = document.getElementById('home');
    const historySection = document.getElementById('history');

    const favList = document.getElementById('favList');
    const histList = document.getElementById('histList');

    const backFromFav = document.getElementById('backFromFav');
    const clearFav = document.getElementById('clearFav');
    const backFromHist = document.getElementById('backFromHist');
    const clearHist = document.getElementById('clearHist');

    /* ====== Storage helpers ====== */
    function load(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) || fallback }catch(e){return fallback} }
    function save(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

    function getFavorites(){ return load('gv_favorites', []) }
    function getHistory(){ return load('gv_history', []) }

    /* ====== UI renderers ====== */
    function renderCurrent(){
      if(!state.current) return;
      verseText.textContent = state.current.text;
      verseRef.textContent = state.current.ref || '';
      devotionalEl.textContent = state.current.devotional || '';
      // update fav button
      const exists = getFavorites().some(v=>v.ref===state.current.ref && v.text===state.current.text);
      favBtn.textContent = exists? '‚ù§Ô∏è Favoritado':'ü§ç Favoritar';
    }

    function renderFavorites(){
      const favs = getFavorites();
      favList.innerHTML = '';
      if(favs.length===0){ favList.innerHTML = '<div style="color:var(--muted)">Nenhum favorito ainda.</div>'; return; }
      favs.reverse().forEach(item=>{
        const el = document.createElement('div'); el.className='list-item';
        el.innerHTML = `<div style="font-family:'Playfair Display',serif">${item.text}</div><div class="item-ref">${item.ref}</div><div style="margin-top:8px"><button class='btn ghost' data-ref='${item.ref}'>Compartilhar</button> <button class='btn ghost' data-del='${item.ref}'>Remover</button></div>`;
        favList.appendChild(el);
      });
    }

    function renderHistory(){
      const hist = getHistory();
      histList.innerHTML = '';
      if(hist.length===0){ histList.innerHTML = '<div style="color:var(--muted)">Hist√≥rico vazio.</div>'; return; }
      hist.slice().reverse().forEach(item=>{
        const el = document.createElement('div'); el.className='list-item';
        el.innerHTML = `<div style="font-family:'Playfair Display',serif">${item.text}</div><div class="item-ref">${item.ref} <small style='color:var(--muted)'>‚Äî ${new Date(item.time).toLocaleString()}</small></div><div style="margin-top:8px"><button class='btn ghost' data-ref='${item.ref}'>Ver</button></div>`;
        histList.appendChild(el);
      });
    }

    /* ====== Core features ====== */
    async function generateRandom(){
      // estrat√©gia: buscar aleatoriamente de FALLBACK_VERSES. Tamb√©m tentamos busca na API se quisermos implementar refer√™ncias din√¢micas.
      const rand = Math.floor(Math.random()*FALLBACK_VERSES.length);
      const chosen = FALLBACK_VERSES[rand];
      state.current = chosen;
      pushToHistory(chosen);
      renderCurrent();
    }

    function pushToHistory(item){
      const hist = getHistory(); hist.push({...item, time:Date.now()}); save('gv_history', hist);
    }

    function toggleFavorite(){
      const favs = getFavorites();
      const existsIdx = favs.findIndex(v=>v.ref===state.current.ref && v.text===state.current.text);
      if(existsIdx>-1){ favs.splice(existsIdx,1); } else { favs.push(state.current); }
      save('gv_favorites', favs);
      renderCurrent();
    }

    async function shareCurrent(){
      if(navigator.share){
        try{ await navigator.share({ title: state.current.ref || 'Vers√≠culo', text: `${state.current.text}\n‚Äî ${state.current.ref}` }); }
        catch(e){ console.log('share cancelled',e) }
      } else {
        // fallback: copiar para clipboard
        const text = `${state.current.text}\n‚Äî ${state.current.ref}`;
        try{ await navigator.clipboard.writeText(text); alert('Vers√≠culo copiado para a √°rea de transfer√™ncia.'); }
        catch(e){ alert('Compartilhar n√£o suportado neste navegador.'); }
      }
    }

    /* ====== Navigation ====== */
    openFavBtn.addEventListener('click',()=>{
      homeSection.style.display='none'; favoritesSection.style.display='block'; historySection.style.display='none'; renderFavorites();
    });
    backFromFav.addEventListener('click',()=>{ favoritesSection.style.display='none'; homeSection.style.display='block'; });
    clearFav.addEventListener('click',()=>{ if(confirm('Apagar todos os favoritos?')){ save('gv_favorites',[]); renderFavorites(); } });

    openHistBtn.addEventListener('click',()=>{ homeSection.style.display='none'; favoritesSection.style.display='none'; historySection.style.display='block'; renderHistory(); });
    backFromHist.addEventListener('click',()=>{ historySection.style.display='none'; homeSection.style.display='block'; });
    clearHist.addEventListener('click',()=>{ if(confirm('Apagar hist√≥rico?')){ save('gv_history',[]); renderHistory(); } });

    /* ====== List interactions (event delegation) ====== */
    favList.addEventListener('click', async (e)=>{
      const ref = e.target.getAttribute('data-ref');
      const del = e.target.getAttribute('data-del');
      if(ref){
        // share favorite
        const item = getFavorites().find(v=>v.ref===ref);
        if(item){ state.current = item; await shareCurrent(); }
      }
      if(del){
        let favs = getFavorites(); favs = favs.filter(v=>v.ref!==del); save('gv_favorites', favs); renderFavorites();
      }
    });

    histList.addEventListener('click', (e)=>{
      const ref = e.target.getAttribute('data-ref');
      if(ref){
        const item = getHistory().reverse().find(v=>v.ref===ref);
        if(item){ state.current = item; homeSection.style.display='block'; favoritesSection.style.display='none'; historySection.style.display='none'; renderCurrent(); }
      }
    });

    /* ====== Buttons ====== */
    generateBtn.addEventListener('click', generateRandom);
    favBtn.addEventListener('click', toggleFavorite);
    shareBtn.addEventListener('click', shareCurrent);

    /* ====== Dark mode + Install prompt ====== */
    const darkToggle = document.getElementById('darkToggle');
    darkToggle.addEventListener('click', ()=>{ document.body.classList.toggle('dark'); });

    // Install prompt handling
    let deferredPrompt = null;
    const installBtn = document.getElementById('installBtn');
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault(); deferredPrompt = e; installBtn.style.display='inline-block';
    });
    installBtn.addEventListener('click', async ()=>{
      if(!deferredPrompt) return; deferredPrompt.prompt(); const choice = await deferredPrompt.userChoice; deferredPrompt = null; installBtn.style.display='none';
    });

    /* ====== Init ====== */
    (function init(){
      // Load last shown verse from history if exists
      const hist = getHistory();
      if(hist.length>0){ state.current = hist[hist.length-1]; } else { state.current = FALLBACK_VERSES[0]; }
      renderCurrent();

      // Try to fetch a fresh verse on first load (non-blocking)
      // For demo, usamos fallback random. Se quiser integra√ß√£o com API por refer√™ncia, implementar aqui.

      // Register service worker
      if('serviceWorker' in navigator){ navigator.serviceWorker.register('/service-worker.js').then(()=>console.log('SW registrado')).catch(()=>console.log('SW falhou')) }
    })();

  </script>
</body>
</html>
